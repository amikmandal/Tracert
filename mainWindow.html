<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tracert</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
   <style>
       #map {
           height: 600px;
       }
   </style>
</head>
<body>
    <h1>Tracert</h1>
    <div id="map"></div>
    <br/>
    <form id="urlForm">
        <div>
            <label>Enter IPv4/Domain </label>
            <input type="text" id="url" autofocus>
            <button type="submit"> Trace Route </button>
        </div>
    </form>
    <p id="message">Enter url to trace route to and hit the button to start tracing</p>
</body>
<script>
    const electron = require('electron');
    const {ipcRenderer} = electron;
    const leaflet = require('leaflet');

    let points = []
    let polyline = null
    
    const form = document.querySelector('#urlForm');
    form.addEventListener('submit', submitForm);

    const msg = document.querySelector('#message');

    var myMap = L.map('map').setView([35,0], 2);
    const tileURL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
    L.tileLayer(tileURL, {}).addTo(myMap);

    function submitForm(e){
        e.preventDefault();
        const url = document.querySelector('#url').value;
        ipcRenderer.send('url', url);
        breakLine();
        breakLine();
        msg.innerHTML += 'Tracing route to ' + url;
        breakLine();
        msg.innerHTML += 'Printing out identifiable IP addresses:'
        breakLine();
    }

    //Catch when output is logged
    ipcRenderer.on('ip', function(e,ip){
        msg.innerHTML += ip;
        breakLine();
        //msg.innerHTML += ipList.length + ' IPv4 Addresses of identifiable hops found.'
    });

    //Catch when location data is logged
    ipcRenderer.on('geoLocData', function(e,geoLocData){
        console.log(geoLocData.latitude, geoLocData.longitude);
        const latlng = [geoLocData.latitude, geoLocData.longitude]
        const marker = L.marker(latlng).addTo(myMap)
        marker.bindTooltip(geoLocData.city)
        marker.on('mouseover', function (e) {
            this.openTooltip();
        });
        marker.on('mouseout', function (e) {
            this.closeTooltip();
        });
        points.push(latlng);
        if (points.length > 2)
            points.shift()
        if(polyline == null)
            polyline = L.polyline(points, {color: 'red'}).addTo(myMap)
        else
            polyline.addLatLng([latlng[0],latlng[1]]);
        myMap.fitBounds(polyline.getBounds());
    });

    function breakLine(){
        msg.innerHTML += '<br>'
    }

</script>
</html>